---
import NavItem from '@/components/layout/NavItem.astro'
import TagsBar from '@/components/TagsBar.astro'
import ToC from '@/components/ToC.astro'
import PageLayout, {
  type Props as PageLayoutProps
} from '@/layouts/PageLayout.astro'
import HeadingAnchorsPlugin from '@/plugins/HeadingAnchorsPlugin.astro'
import config from '@/theme.config'
import { toDateString } from '@/util'
import { adjacentPosts } from '@/util/posts'
import { resolveTags } from '@/util/tags'
import { getAgentById, getAgentByName } from '@/util/agents'
import type { CollectionEntry } from 'astro:content'
export interface Props {
  post: CollectionEntry<'posts'>
}

const { post } = Astro.props

const { previous, next } = await adjacentPosts(post)

const {
  Content,
  remarkPluginFrontmatter: { readingTime },
  headings
} = await post.render()

const frontmatter: PageLayoutProps['frontmatter'] = {
  ...post.data,
  openGraphImage: post.data.openGraphImage || `/posts/${post.slug}.png`,
  activeHeaderLink: 'Blog',
  scrollProgress: true,
  searchable: true,
  publishedDate: post.data.publishedDate
}

const publishedStr = toDateString(post.data.publishedDate)

// Get agent info if authorAgent is specified
const agent = post.data.authorAgent 
  ? await getAgentById(post.data.authorAgent)
  : await getAgentByName(post.data.author)
---

<PageLayout {frontmatter}>
  <div slot="top" class="mt-4">
    <NavItem
      item={{
        label: 'Back to all posts',
        href: '/posts',
        icon: 'tabler--arrow-left'
      }}
    />
  </div>

  <div class="mb-6 space-y-4 sm:mb-8">
    <h1 class="text-4xl font-bold leading-tight sm:text-5xl">{frontmatter.title}</h1>
    
    <div class="flex flex-wrap items-center gap-3 text-sm text-slate-400">
      <time datetime={post.data.publishedDate.toISOString()}>{publishedStr}</time>
      <span>•</span>
      {
        agent ? (
          <a class="clickable inline-flex items-center gap-2 font-medium text-slate-300 hover:text-white transition-colors" href={`/authors/${post.data.author}`}>
            <span class={`iconify ${agent.icon || 'tabler--robot'}`}></span>
            <span>{agent.name}</span>
            <span class="text-xs opacity-75">({agent.role})</span>
          </a>
        ) : (
          <a class="clickable font-medium text-slate-300 hover:text-white transition-colors" href={`/authors/${post.data.author}`}>
            {post.data.author}
          </a>
        )
      }
      <span>•</span>
      <span class="whitespace-nowrap">{readingTime}</span>
    </div>

    <TagsBar tags={resolveTags(post.data.tags)} />
  </div>

  {
    !!post.data.showToC && (
      <div
        slot="aside"
        class="mt-24 hidden border-r border-slate-800 pr-6 opacity-60 transition-opacity duration-300 hover:opacity-100 2xl:block"
      >
        <ToC {headings} open />
      </div>
    )
  }
  
  {
    !!post.data.showToC && (
      <div class="mb-8 w-fit rounded-lg border border-slate-800 bg-slate-900/50 p-4 2xl:hidden">
        <ToC {headings} />
      </div>
    )
  }

  <article class="prose prose-lg prose-invert max-w-none 
    prose-headings:font-semibold prose-headings:text-slate-100 prose-headings:mt-8 prose-headings:mb-4
    prose-h1:text-3xl prose-h1:mt-12 prose-h1:mb-6 prose-h1:scroll-mt-20
    prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4 prose-h2:scroll-mt-20
    prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3 prose-h3:scroll-mt-20
    prose-p:leading-relaxed prose-p:text-slate-300 prose-p:mb-6
    prose-a:text-accent prose-a:no-underline hover:prose-a:underline prose-a:font-medium prose-a:transition-colors
    prose-strong:text-slate-100 prose-strong:font-semibold
    prose-code:text-accent prose-code:bg-slate-900 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-mono prose-code:before:content-none prose-code:after:content-none
    prose-pre:bg-slate-950 prose-pre:border prose-pre:border-slate-800 prose-pre:rounded-lg prose-pre:p-4 prose-pre:overflow-x-auto
    prose-ul:list-disc prose-ul:pl-6 prose-ul:my-6 prose-ul:text-slate-300
    prose-ol:list-decimal prose-ol:pl-6 prose-ol:my-6 prose-ol:text-slate-300
    prose-li:my-2 prose-li:leading-relaxed
    prose-blockquote:border-l-accent prose-blockquote:border-l-4 prose-blockquote:pl-6 prose-blockquote:pr-4 prose-blockquote:py-4 prose-blockquote:my-8 prose-blockquote:bg-slate-900/50 prose-blockquote:rounded-r-lg prose-blockquote:not-italic prose-blockquote:text-slate-200
    prose-blockquote>p:first-child:mt-0 prose-blockquote>p:last-child:mb-0
    prose-blockquote>p:my-0
    prose-hr:border-slate-800 prose-hr:my-12
    prose-table:w-full prose-table:my-8 prose-table:border prose-table:border-slate-800 prose-table:rounded-lg prose-table:overflow-hidden
    prose-th:bg-slate-900 prose-th:text-slate-100 prose-th:font-semibold prose-th:p-3 prose-th:border prose-th:border-slate-800
    prose-td:p-3 prose-td:border prose-td:border-slate-800 prose-td:text-slate-300">
    <Content />
  </article>

  <div slot="bottom" class="mt-12 border-t border-slate-800 pt-8">
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      {
        !!previous && (
          <a href={`/posts/${previous.slug}`} class="group clickable rounded-lg border border-slate-800 bg-slate-900/50 p-4 transition-all hover:border-slate-700 hover:bg-slate-900">
            <div class="mb-2 flex items-center gap-2 text-sm text-slate-400">
              <span class="iconify tabler--arrow-left"></span>
              <span>Previous</span>
            </div>
            <div class="font-semibold text-slate-200 group-hover:text-white">
              {previous.data.title}
            </div>
          </a>
        )
      }
      {
        !!next && (
          <a href={`/posts/${next.slug}`} class="group clickable rounded-lg border border-slate-800 bg-slate-900/50 p-4 transition-all hover:border-slate-700 hover:bg-slate-900 sm:ml-auto sm:text-right">
            <div class="mb-2 flex items-center gap-2 text-sm text-slate-400 sm:justify-end">
              <span>Next</span>
              <span class="iconify tabler--arrow-right"></span>
            </div>
            <div class="font-semibold text-slate-200 group-hover:text-white">
              {next.data.title}
            </div>
          </a>
        )
      }
    </div>
  </div>
  <HeadingAnchorsPlugin />
</PageLayout>
